#!/usr/bin/env python

import virustotal
import psycopg2, argparse, getpass, json, sys, urllib2, socket

def main():
  # Arguments
  parser = argparse.ArgumentParser(description='Scan the files',
      add_help=False)
  parser.add_argument('--help', action='help', help='show this help \
      message.')
  parser.add_argument('-h', metavar='host', type=str, required=True)
  parser.add_argument('-d', metavar='database', type=str, required=True)
  parser.add_argument('-u', metavar='username', type=str, required=True)
  parser.add_argument('-l', metavar='LAN IP of localhost', type=str,
      required=True)
  parser.add_argument('-c', metavar='virustotal config file', type=str,
      required=True)
  args = parser.parse_args()

  passwd = getpass.getpass()
  vtconfigfile = args.c

  try:
    # Establish the connection to the database.
    sql = 'host=%s dbname=%s user=%s password=%s' % \
        (args.h, args.d, args.u, passwd)
    conn = psycopg2.connect(sql)
    cur =  conn.cursor()

    count = 0

    while True:
      # Get an app that is not scanned.
      sql = 'SELECT a_id, a_name, a_path FROM apps WHERE random() < 0.01 \
          AND a_vt_sha256 IS NULL AND a_ipaddress = %s LIMIT 1'
      cur.execute(sql, (args.l,))
      app = cur.fetchone()
      if app == None:
        break

      a_id, a_name, a_path = app
      count += 1

      # Progress bar
      sys.stdout.write('\r')
      for i in range(80):
        sys.stdout.write(' ')
      sys.stdout.write('\r[Req. %d] Upload %s ' \
          % (count, a_name))
      sys.stdout.flush()

      try:
        # Get the response.
        response = virustotal.scan_file(a_path, vtconfigfile, verbose=True)

        # Update the database.
        sql = 'UPDATE apps SET a_vt_sha256 = %s WHERE a_id = %s'
        cur.execute(sql, (response['sha256'], a_id))
        conn.commit()

      except urllib2.HTTPError as e:
        # Update with empty JSON.
        sql = 'UPDATE apps SET a_vt_sha256 = %s WHERE a_id = %s'
        cur.execute(sql, ('', a_id))
        conn.commit()
      
      except socket.error as e:
        pass

    # End of the progress bar
    print ''

  except Exception as e:
    print e

  finally:
    cur.close()
    conn.close()


if __name__ == '__main__':
  main()

